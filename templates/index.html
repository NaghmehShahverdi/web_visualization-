<!DOCTYPE html>
<html lang="en">

<head>
  {% load static %}
  {% load custom_filters %}

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="{% static 'css/main.css' %}" />
  <link rel="stylesheet" href="{% static 'css/table.css' %}" />


  <title>Search and Filter Template</title>
</head>

<body>
  <div class="dark-overlay"></div>
  <input type="hidden" id="count" value="{{ count }}">
  <div class="content">
    <p><a href="/">Mapping Schizophrenia's Cellular Etiology: Integrating snRNAseq and GWASs</a></p>
    <h3p>Welcome to our platform, where we offer four specialized tables that allow you to explore gene specificity
      ranks and their p-values in relation to schizophrenia. Tables can be tailored based on different thresholds for
      p-values, specificity ranks, or gene names.

      To sort tables by a specific column, simply click on the column header. Clicking the column header again will
      reverse the sort order. For information on a specific gene or value, use the search box located above the table.
      </h3>
  </div>
  <div id="container">
    <form id="form" action="{% url 'index' %}" method="get">
      <div id="search_filter">
        <select id="visualization" class="dropdown" name="visualization">
          <option value="option0" selected hidden disabled>Select Option</option>
          <option value="option1" {% if visualization == 'option1' %}selected{% endif %}>Cluster Information</option>
          <option value="option2" {% if visualization == 'option2' %}selected{% endif %}>Specificity Profile of a Gene
            Across Clusters</option>
          <option value="option3" {% if visualization == 'option3' %}selected{% endif %}>Gene Expression Specificity Across Clusters</option>
        </select>

        <input name="cluster" type="text" id="input_cluster_id" placeholder="Cluster ID" value="{{ cluster }}">
        <input name="gene" type="text" id="input_gene" placeholder="Gene" value="{{ gene }}" autocomplete="off">
        <input id="search_button" type="submit" value="search">
        <ul id="suggestionList"></ul>
      </div>
    </form>
    <span id="dl_and_desc">
      <div id="description"> </div>
      <div id="download_button_container"> </div>
    </span>
    <span id="lazy_load">
      <p>LOADING</p>
      <svg version="1.1" id="L7" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px"
        y="0px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve">
        <path fill="#fff" d="M31.6,3.5C5.9,13.6-6.6,42.7,3.5,68.4c10.1,25.7,39.2,38.3,64.9,28.1l-3.1-7.9c-21.3,8.4-45.4-2-53.8-23.3
      c-8.4-21.3,2-45.4,23.3-53.8L31.6,3.5z">
          <animateTransform attributeName="transform" attributeType="XML" type="rotate" dur="2s" from="0 50 50"
            to="360 50 50" repeatCount="indefinite" />
        </path>
        <path fill="#fff" d="M42.3,39.6c5.7-4.3,13.9-3.1,18.1,2.7c4.3,5.7,3.1,13.9-2.7,18.1l4.1,5.5c8.8-6.5,10.6-19,4.1-27.7
      c-6.5-8.8-19-10.6-27.7-4.1L42.3,39.6z">
          <animateTransform attributeName="transform" attributeType="XML" type="rotate" dur="1s" from="0 50 50"
            to="-360 50 50" repeatCount="indefinite" />
        </path>
        <path fill="#fff" d="M82,35.7C74.1,18,53.4,10.1,35.7,18S10.1,46.6,18,64.3l7.6-3.4c-6-13.5,0-29.3,13.5-35.3s29.3,0,35.3,13.5
      L82,35.7z">
          <animateTransform attributeName="transform" attributeType="XML" type="rotate" dur="2s" from="0 50 50"
            to="360 50 50" repeatCount="indefinite" />
        </path>
      </svg>
    </span>
    <div id="additional_info"></div>
    <div id="results"></div>

  </div>


  <script src="{% static 'js/table.js' %}"></script>

  <script>
    const parser = new DOMParser();
    const doc = parser.parseFromString("{{ additional_info }}", 'text/html');
    additional_info.innerHTML = doc.body.textContent;;

    {% if count != 0 and count != None %}
    var gridData = [];
    var gridColumns = [];
    {% if visualization == 'option3' %}
    results.innerHTML= '<img class="graph" src="data:image/png;base64,{{ results }}" />'
    {% elif visualization == 'option2' %}
    gridColumns = [{ id: "cluster", name: gridjs.html('<div title="{{ columns_desc.cluster }}">Cluster</div>') },
    { id: "gene_number", name: gridjs.html('<div title="{{ columns_desc.gene_number }}">Gene Number</div>') },
    { id: "specificity_rank", name: gridjs.html('<div title="{{ columns_desc.specificity_rank }}">Specificity Rank</div>') },
    { id: "specificity_value", name: gridjs.html('<div title="{{ columns_desc.specificity_value }}">Specificity Value</div>') },
    { id: "super_cluster", name: gridjs.html('<div title="{{ columns_desc.super_cluster }}">Super Cluster</div>') },
    { id: "color", name: gridjs.html('<div title="{{ columns_desc.color }}">Color</div>'), sort: false }];
    {% for item in results %}
    gridData.push([{{ item.cluster }}, {{ item.gene }}, {{ item.spe_rank }}, {{ item.spe_val }}, "{% ss_separator item.get_cluster_display '#' %}", gridjs.html(
      `<span style="background-color:#{% ss_separator item.get_cluster_display '#' 'color' %}" class="super-cluster"></span>`
    )]);
    {% endfor %}
    {% elif visualization == 'option1' %}
    gridColumns = [{ id: "name", name: gridjs.html('<div title="{{ columns_desc.name }}">Name</div>') },
    { id: "gene_number", name: gridjs.html('<div title="{{ columns_desc.gene_number }}">Gene Number</div>') },
    { id: "p_value", name: gridjs.html('<div title="{{ columns_desc.p_value }}">p-Value</div>') },
    { id: "specificity_rank", name: gridjs.html('<div title="{{ columns_desc.specificity_rank }}">Specificity Rank</div>') },
    { id: "specificity_value", name: gridjs.html('<div title="{{ columns_desc.specificity_value }}">Specificity Value</div>') }]
    {% for item in results %}
    gridData.push(["{{ item.name }}", {{ item.gene }}, {{ item.scz_2022_p }}, {{ item.spe_rank }}, {{ item.spe_val }}]);
    {% endfor %}
    {% endif %}

    {% if visualization != 'option0' %}
    document.addEventListener('DOMContentLoaded', function () { setDownloadInfo(gridColumns, gridData) })
    {% endif %}

    new gridjs.Grid({
      pagination: {
        limit: 30,
        summary: false,
        resetPageOnUpdate: false
      },
      sort: true,
      fixedHeader: true,
      search: true,
      columns: gridColumns,
      data: gridData,
      style: {
        table: {
          'border': '2px solid rgb(39, 42, 47)',
          'background-color': 'rgba(0, 0, 0, 0)'
        },
        th: {
          'color': '#fff',
          'border': '2px solid #1b9d8c',
          'text-align': 'center',
          'background-color': 'rgba(16, 89, 80, 0.671)'
        },
        td: {
          'background-color': '#080c13',
          'text-align': 'center',
          'color': 'rgb(144, 167, 174)',
          'border': '2px solid rgb(39, 42, 47)',
        }
      }
    }).render(document.getElementById("results"));

    {% endif %}

  </script>



  <script src="{% static 'js/main.js' %}"></script>
  <script src="{% static 'js/gene_filter.js' %}"></script>
  <script src="{% static 'js/csv.js' %}"></script>
</body>

</html>